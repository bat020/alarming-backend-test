<html>
  <head>
    <link rel='stylesheet' href='style.css'>
    <script src='https://cdn.firebase.com/js/client/2.3.1/firebase.js'></script>
    <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js'></script>
    <script src='alarmtest.js'></script>
  </head>
  <body>

    <h1>Alarming backend test</h1>

    <p id='status-message'>status message goes here</p>

    <p><button id='logout-button'>log out</button></p>

    <p><input id='username' type='text' placeholder='username' autofocus autocomplete='off'></p>
    <p><input id='email' type='email' placeholder='email' autocomplete='off'></p>
    <p><input id='password' type='password' placeholder='password' autocomplete='off'></p>
    <p><button id='login-button'>log in</button> or <button id='signup-button'>signup</button></p>

    <script>

      var ref = new Firebase('https://blazing-fire-4780.firebaseio.com/alarming');
      var usersRef = ref.child('users');
      var eventsRef = ref.child('events');

      $('#logout-button').click(function (){
        ref.unauth();
      });

      $('#login-button').click(function (){
        ref.authWithPassword({
          email: $('#email').val(),
          password: $('#password').val()
        }, authHandler);
      });

      $('#signup-button').click(function (){
        ref.createUser({
          email: $('#email').val(),
          password: $('#password').val()
        }, signupHandler);
      });

      ref.onAuth(authDataCallback);

      function authHandler(error, authData) {
        // console.log('authHandler has been triggered');
        if (error) {
          $('#status-message').text("Login failed! " + error);
        } else {
          // $('#status-message').text("Authenticated successfully as " + authData.uid);
          clearLoginForm();
          saveNewUser(authData);
        }
      };

      function signupHandler(error, userData) {
        console.log('signupHandler has been triggered');
        if (error) {
          switch (error.code) {
            case "EMAIL_TAKEN":
              $('#status-message').text("The new user account cannot be created because the email is already in use.");
              break;
            case "INVALID_EMAIL":
              $('#status-message').text("The specified email is not a valid email.");
              break;
            default:
              $('#status-message').text("Error creating user:", error);
          }
        } else {
          $('#status-message').text("Successfully created user account with uid:", userData.uid);
          ref.authWithPassword({
            email: $('#email').val(),
            password: $('#password').val()
          }, authHandler);
        }
      }

      function authDataCallback(authData) {
        if (authData) {
          usersRef.child(authData.uid).on("value", function(snapshot) {
              $('#status-message').text(snapshot.val().username + " is logged in");
          });
        } else {
          $('#status-message').text("user is logged out");
        }
      };

      function clearLoginForm() {
        $('#email').val("");
        $('#password').val("");
      };

      function saveNewUser(authData) {
        usersRef.child(authData.uid).set({
          email: authData.password.email,
          username: $('#username').val()
        });
      };

    </script>
  </body>
</html>
